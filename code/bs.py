from malware_model import build,fit_predict,METRIC,get_score 
import os
import pandas as pd
import numpy as np

def bw(model_name):
    bad = []
    mode = 'cv'
    X,Xt,y,yt,names,tr_id,te_id = build(mode,build_list=[1],cache=[0])
    yp,model = fit_predict(names,X,y,Xt,yt,model_name=model_name)
    best = get_score(yt,yp,METRIC)
    for i in range(X.shape[1]):
        bf = None
        for col in names:
            if col in bad:
                continue
            X_tmp,Xt_tmp,names_tmp = drop(X,Xt,names,bad+[col])
            yp,model = fit_predict(names_tmp,X_tmp,y,Xt_tmp,yt,model_name=model_name)
            score = get_score(yt,yp,METRIC)
            print(bad+[col],score,best)
            bslog(bad+[col],score)
            if best<score:
                best = score
                bf = col
        if bf is None:
            break
        bad.append(bf)

def drop(X,Xt,names,bad):
    names_tmp = [i for i in names if i not in bad]
    cols = [c for c,i in enumerate(names) if i not in bad]
    assert len(names_tmp) == len(cols)
    return X[:,cols],Xt[:,cols],names_tmp

def bslog(bad,score,name='bs.log'):
    if os.path.exists(name)==0:
        fo = open(name,'w')
        tag = 'bad' if name == 'bs.log' else 'good'
        fo.write('%s,score\n'%tag)
        fo.close()
    fo = open(name,'a')
    fo.write('"%s",%.4f\n'%(str(bad),score))
    fo.close()

def readbs(name='bs.log'):
    df = pd.read_csv(name)
    df = df.sort_values(by='score',ascending=False)
    print(df[['bad','score']].head())

if __name__ == '__main__':
    bw('xgb')
