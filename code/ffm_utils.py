import os
import csv
import sys

def fit_transform(id_col,y_col,tr_path,va_path,tr_out_path,va_out_path):
    # te_paths is a list
    fea_dic = csv2ffm(tr_path,tr_out_path,id_col,y_col,fea_dic={},update=True) 
    _ = csv2ffm(va_path,va_out_path,id_col,y_col,fea_dic=fea_dic,update=False)

def csv2ffm(inx,out,id_col,y_col,fea_dic={},update=False,ignorenan=True,mtr=None,bl=0,bar=0,na=''):
    print("csv2ffm",out)
    if os.path.exists(out):
        return fea_dic
    f = open(inx)
    head = f.readline().strip()
    fields = head.split(',')
    f.close()
    fields = [i for i in fields if i not in [id_col,y_col]]
    field_dic = {i:c for c,i in enumerate(fields)}

    fo = open(out,'w')
    cq = 0
    with open(inx) as f:
        for c,row in enumerate(csv.DictReader(f)):
            line = [row.get(y_col,'0')]
            for field in fields:
                if ignorenan and row[field]==na:
                    continue
                #if '.' in row[field] and len(row[field])>5:
                #    row[field] = row[field][:-1]
                val = "%s-%s"%(field,row[field])
                if mtr is not None and (val not in mtr or abs(mtr[val]-bl)<bar):
                    cq += 1
                    continue
                if val not in fea_dic:
                    if update:
                        fea_dic[val] = len(fea_dic)+1
                    else:
                        continue
                m = field_dic[field]
                n = fea_dic.get(val,'0')
                line.append("%s:%s:1"%(m,n))
            line = " ".join(line)
            fo.write(line+'\n')
            if c>0 and c%100000 ==  0:
                print(c,out,'written','ignore',cq)
    fo.close()
    return fea_dic

if __name__ == '__main__':
    #tr_path,va_path,te_path,id_col,y_col = sys.argv[1:]
    id_col,y_col,tr_path,va_path,tr_out_path,va_out_path = sys.argv[1:]
    fit_transform(id_col,y_col,tr_path,va_path,tr_out_path,va_out_path)
