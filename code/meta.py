from ml_robot import search_ng
import pandas as pd
from time import time
from ml_robot import write_log
import numpy as np
from malware_model import YCOL,IDCOL,METRIC
from ml_robot.metrics import get_score
import os
import glob

def meta():
    
    start = time()
    #xx = list(range(17,25))#+[222,223,225,227,231]
    xx = [110,321,348]
    paths = get_meta_paths(xx)

    y = pd.read_pickle('cache/va_y.pkl')[YCOL].values

    X,s = get_meta(paths,'cv')
    #for i in range(X.shape[1]):
    #    X[:,i] = X[:,i].argsort().argsort()*1.0/X.shape[0]
    model = search_ng(feval=METRIC,silent=False,lr=0.1,iters=20,ave=False,maximize=True)
    model.fit(X,y)
    #model.fit2(X,y)
    #model.bw = np.array([[1,1,2]])
    yp = model.predict(X)
    score = get_score(y,yp,METRIC)
    print(score)


    s[YCOL] = yp 
    s.to_csv('cv_meta.csv.gz',index=False,compression='gzip')#,float_format='%.4f')

    Xt,s = get_meta(paths,'sub')
    yp = model.predict(Xt)

     
    print(score,'meta search ng')
    s[YCOL] = yp 
    s.to_csv('sub_meta.csv.gz',index=False,compression='gzip')#,float_format='%.4f')
    duration = time()-start
    write_log(duration,score,'meta search ng %s'%(str(xx)),mfiles=['cv_meta.csv.gz','sub_meta.csv.gz'])

def get_meta(paths,mode):
    df = []
    for i in paths:
        name = glob.glob("%s/*%s*.csv.gz"%(i,mode))
        name = [j for j in name if 'post' not in j]
        name = name[-1:]
        print(name)
        assert len(name) == 1
        name = name[0]
        dt = pd.read_csv(name)
        df.append(dt)
    if mode == 'cv':
        X = []
        for i in df:
            if IDCOL in i.columns:
                i.drop(IDCOL,axis=1,inplace=True)
            if 'real' in i.columns:
                i.drop('real',axis=1,inplace=True)
            X.append(i.values)
    else:
        X = [i.drop(IDCOL,axis=1).values for i in df]
    return np.hstack(X),df[0]

def get_meta_paths(lines):
    paths = {}
    with open('run.log') as f:
        for c,line in enumerate(f):
            if c+1 in lines:
                ps = line.split(',')[:2]
                path = 'backup/%s_cv_%s'%(ps[0],ps[1])
                paths[c+1] = path
    paths = [paths[i] for i in lines]
    for i in paths:
        print(i)
    return paths

if __name__ == '__main__':
    meta()
